■アプリケーション概要
このアプリケーションは、Android Automotive OS (AAOS) 上で動作することを想定したビデオデコードテストアプリです。 主な目的は、USBストレージデバイスに保存されているH.264およびH.265形式のビデオビットストリームファイルをデコードし、その結果をYUV形式の生ビデオデータとして同じUSBストレージデバイスに出力することです。最終的には、ITU-T H.265 (HEVC) の Video Decoder Compliance Test をパスすることを目指しています。

当初はAndroid標準の MediaCodec APIを使用してデコード処理を行っていましたが、一部のビットストリームでデコードに失敗する課題がありました。この課題を解決するため、より堅牢で対応コーデックの多い FFmpegライブラリ をアプリケーションに組み込み、デコード処理をFFmpegベースに移行する改修が行われました。

■主な機能
1. ファイルブラウジングと選択:
- アプリケーションの内部ストレージ、およびUSBストレージデバイス上のビデオファイル（.264, .h264, .avc, .jsv, .jvt, .bit, .bin, .hevc, .h265 などの拡張子を持つファイル）をリスト表示します。
- ユーザーはリストからデコード対象のファイルを選択できます。
- USBストレージへのアクセスには、Storage Access Framework (SAF) を利用し、ユーザーにディレクトリ選択を促します。

2. ビデオデコード処理 (FFmpegベース):
- 選択されたビデオファイルをFFmpegライブラリを使用してデコードします。
- H.264およびH.265コーデックに対応しています。
- デコード処理はバックグラウンドスレッドで実行され、UIのブロッキングを防ぎます。
- 処理中はプログレスバーが表示されます。

3. YUVデータ出力:
- デコードされたビデオフレームは、YUV形式（主にYUV420Pを想定）の生データとしてファイルに出力されます。
- 出力ファイル名は、入力ファイル名に .yuv 拡張子を付加したものになります。
- 出力先は、入力ファイルがUSBストレージにあれば同じUSBストレージ内の result_usb_ffmpeg フォルダ、内部ストレージにあればアプリ固有ディレクトリ内の result_ffmpeg フォルダとなります。

4. UI:
- ファイルリスト表示用の ListView。
- ファイルリスト更新ボタン、USBストレージ選択ボタン、デコード開始ボタン。
- 処理状況を示すプログレスバーとトーストメッセージによるフィードバック。

■技術的特徴
1. FFmpegの利用: 中核となるデコード処理にFFmpegを使用しています。
- JNI (Java Native Interface) を介してJavaコードからFFmpegのネイティブ関数を呼び出します。
- ネイティブラッパー (ffmpeg_jni.cpp) がFFmpegのAPIを直接操作し、ビデオファイルの読み込み、デコード、YUVデータの抽出を行います。
- ファイルパス指定によるデコードと、Content URI指定によるデコード（内部的にファイルディスクリプタと一時ファイルを利用）の両方に対応しています。

2. ストレージアクセス:
- Androidの StorageManager や DocumentFile APIを使用して、USBストレージデバイス上のファイルにアクセスします。

3. UIと非同期処理: 
- AppCompatActivity, ListView, Button, ProgressBar などの標準的なAndroid UIコンポーネントを使用し、ExecutorService と Handler を用いてデコード処理を非同期に実行します。

■今後の開発・注意点
FFmpegライブラリの管理: 現在のソースコードには、ビルド済みのFFmpegライブラリ (.so ファイル) およびヘッダファイルは含まれていません。これらは別途ビルドし、プロジェクトの所定のディレクトリ (app/src/main/jniLibs, app/src/main/cpp/include/ffmpeg) に配置する必要があります。FFmpegのビルドは、ターゲットとするCPUアーキテクチャごとに行い、必要なコーデックやプロトコル（特に fd: プロトコル）を有効にする必要があります。
エラーハンドリングと安定性: FFmpegのエラーコードのより詳細なハンドリングや、さまざまなビットストリームに対するデコードの安定性向上は、継続的な課題となります。
パフォーマンス: 大容量のファイルや高解像度のビデオを扱う際のパフォーマンス（デコード速度、メモリ使用量）については、さらなる最適化の余地があるかもしれません。
コンプライアンステスト: ITU-T H.265のコンプライアンステストをパスするためには、より厳密なテストとデバッグが必要になります。
